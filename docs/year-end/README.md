This document discusses the implementation of new pricing and holding structures for a Vision database.

Command Script Files:
--------------
* [CreatePricingStructure.csh](CreatePricingStructure.csh)
* [CreateHoldingStructure.csh](CreateHoldingStructure.csh)

Each script is customized to generate the upcoming year.

When to Run:
------------
These two scripts can be executed any time before new Pricing or Holding records are
updated for the upcoming year.  It is assumed this DBA activity will occur at least
once annually.

We recommend running these scripts several days before the final business day of the year.

Execution Instructions:
-----------------------
Stop your production cycle before running these scripts.

The scripts default to the vision database using the same defaults as `batchvision`.
In many installations this default is set as `$NDFPathName` and `$OSDPathName`. To confirm
your batchvision default you can use `batchvision` and at the `V>` run `ndfPathName` to confirm.
Override these assumptions by setting the environment variable appropriate for your
installation.

Run the scripts from the unix prompt using your best practices.

On some unix based sites this can be executed as

```
csh CreatePricingStructure-2016.csh
```

Verify success using the code below before restarting your cycle or allowing any
updates to your application.

If anything appears to have run incorrectly,
the commits from the jobs can be rolled back and the Object Spaces that were created
(if any were), can physically be deleted from the `localvision/network` directory.
Confirm that they no longer exist by running the `AdminTools objectSpaceList` step below.


Output Logs:
------------
These scripts choose the log area based on your implementation.  Logs will either be in
`localvision/production/batchUnix/logs` or `$updateArea/logs`.  If your implementation uses
`$globalLogs`, a copy will be placed there as well.

Log files are named:

```
CreatePricingStructure-YYYY.DATE
CreateHoldingStructure-YYYY.DATE
```

Where YYYY is the year being generated, such as 2015, and DATE is the date the script executes.

Each processing log will include the output of a query listing the `Pricing` or `Holding` structures in the database.


Validation:
-----------
The following code will help to show what new Object Spaces and structure have
been created for Pricing and Holdings.   These steps can be run on your system
after setting up the new structure for the upcoming year to check if things
look correct.

```
#show existing Object Spaces
AdminTools objectSpaceList
do: [ ^self print: 3; " " print;
      spaceName printNL;
    ] ;
```

This will display a list of existing Object Spaces.  If the scripts to setup new
Pricing and Holdings structures have been run, you should see output like the
following at the bottom of the list:

```
nn Annual Price History Storage As Of yyyy
NN Holdings Data As Of 1/1/yyyy
```

where:
nn   = the OS number of the new Pricing Object Spaces
NN   = the OS number of the new Holdings Object Spaces
yyyy = the year generated by the scripts


Each job which executes includes an output report and log file. Please review
both of them for success.

The log file includes the output of a query that proves the spaces created successfully.


Holdings Validation
--------------------
Confirm the Space created properly.  In the example the year is 2015 and the space is
represented as #28.

From the log file:
```
...  Creating Space #28
 For: Holdings Data As Of 1/1/2015
>>> Object Space 28 Created <<<
>>> Object Network Updated <<<
```

This query outputs all the stores in your Holding structures.  The youngest should be listed with
the name Holdings Data As Of 1/1/2015 and the OS number should reflect the same number generated and
printed in the output log.

```
Holding :storeXRef
   do: [ ^date print:15;
         ^self objectSpace print; " " print;
         ^self objectSpace asObjectSpace spaceName print; " " print;
         ^self instanceList count print:15;
         ^self clusterSize print:15;
         ^self displayPOP
       ];
```

Output should reflect all years plus 2015.  The notation in the block represents the new OS and its segment.
Your OS and segment will be based on your architecture.  The important thing is that there are entries for each
year, and 2015 is in the OS number just generated.

Example output:
```
...
01/01/2015            28 Holdings Data As Of 1/1/2015               1         480.00[  28,   983]
```


Pricing Validation
------------------
Confirm the Space created properly.  In the example the year is 2015 and the space is
represented as #27.  Each of the four entries in this output should note this object space.

From the log file:
```
...  Creating Space #27
 For: Annual Price History Storage As Of 2015
>>> Object Space 27 Created <<<
>>> Object Network Updated <<<
```

Run this query in your vision session:

```
PriceTools :dailyStoreXRef from: ^date - 4 years .
    do: [  ^self objectSpace asObjectSpace spaceName print; " " print;
           ^self objectSpace print:12; " " print;
           ^self instanceList count print; " " print;
           ^date print:12; " " print;
           ^self displayPOP;
         ] . count printNL;
```

Output should reflect the last 3 years plus 2015. The notation in the block represents
the new OS and its segment.

Your OS and segment will be based on your architecture.  The important thing is that
there are four entries for each year, and the intended year is in the OS number just generated.

Example output:
```
...
Annual Price History Storage As Of 2015           27         1 01/01/2015   [  27,   985]
Annual Price History Storage As Of 2015           27         1 04/01/2015   [  27,   982]
Annual Price History Storage As Of 2015           27         1 07/01/2015   [  27,   979]
Annual Price History Storage As Of 2015           27         1 10/01/2015   [  27,   976]
```

